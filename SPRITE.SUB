*********************************************************************************			      SPRITE DRIVERS********************************************************************************BGPOS		EQU	#9800		;#9C00*		PRINT_STRIP		;INDEX LIST*		DEL_STRIPS		*		SCAN_COL*****************************************       PRINT SPRITE FROM TABLE*	  HL = SPRITE NUMBER*	  BC = X Y POSITION****************************************DISP_SPR	LD	A,WORDBANK	;LOOK AT WORD BANK		SETBANK		LD	D,H		;HL * 5		LD	E,L		ADD	HL,HL		ADD	HL,HL		ADD	HL,DE		LD	DE,SPRTAB	;WORD TABLE ADDRESS		ADD	HL,DE		LD	E,(HL)		;GET SPR ADDRESS		INC	HL		LD	D,(HL)		INC	HL		PUSH	DE		;SAVE ADDRESS		LD	D,(HL)		;GET OFFSETS		LDX	A,XOFF		ADD	A,D		LD	D,A		;LD	A,(OFFCLR)	;TEST FOR OFFSET CLEARING		;AND	A		;JP	Z,@NOCLR		;LD	D,0@NOCLR		LD	A,(MIR)		AND	A		JP	Z,@1		LD	A,C		SUB	8		LD	C,A		LD	A,D		CPL		INC	A		LD	D,A@1		LD	E,C		CALL	ADDOFF_X		LD	C,A		;ADD X OFF		INC	HL		LD	D,(HL)		;ADD Y OFF		LDX	A,YOFF		ADD	A,D		LD	D,A				LD	E,B		CALL	ADDOFF_Y		LD	B,A		INC	HL		LD	A,(HL)		;BASE BANK NUMBER		SETBANK			;SET SPRITE BANK		POP	HL		;HL NOW POINTS TO SPRITE DATA		CP	16		RET	NC		AND	A		RET	Z		LD	A,H		OR	L		RET	Z					;OFFXY CONTAINS THE OFFSETS		CALL	DRAW_SPR		RET******************************************      PRINT SPRITE AT RAW ADDRESS*	     HL = ADDRESS*	     BC = X Y POSITION*	      A = BANK****************************************DISP_SPR_ADD	SETBANK		XOR	A		LD	(SKIPLINES),A	;OFFXY CONTAINS THE OFFSETS		LD	D,(HL)		;GET OFFSETS		LD	A,(MIR)		AND	A		JP	Z,@1		LD	A,C		SUB	8		LD	C,A		LD	A,D		CPL		INC	A		LD	D,A@1		LD	A,C		ADD	A,D		LD	C,A		;ADD X OFF		INC	HL		LD	A,B		ADD	A,(HL)		LD	B,A		INC	HL		CALL	DRAW_SPR		RET*****************************************	      ADD OFFSET*	       D = OFFSET*	       E = COORD****************************************ADDOFF_Y	LD	A,D		SRA	A		AND	7		LD	(SKIPLINES),A		SRA	D		SRA	D		SRA	D		SRA	D		LD	A,E		ADD	A,D		LD	E,A		RET*****************************************	      ADD OFFSET*	       D = OFFSET*	       E = COORD****************************************ADDOFF_X	SRA	D		SRA	D		SRA	D		SRA	D		LD	A,E		ADD	A,D		LD	E,A		RET*****************************************           GET WHOLE SPRITE**	    HL = SPRITE DATA****************************************DRAW_SPR	LD	A,C		LD	(XYPOS),A		LD	A,B		LD	(XYPOS+1),A		LD	(ORIGINY),A		LD	A,(SKIPLINES)		LD	(OLDSKIPLINES),A		LD	A,%01010101		LD	(HATCH),A		LD	A,(HLI)			;GET AMOUNT OF SPRITES WIDE		LD	(SPRWIDE),A@MORE		LD	A,(HLI)			;GET TOTAL LINES		LD	C,A@LOOP		XOR	A			;CLEAR OUT BITMASK DATA		LD	(ALLBITS),A		CALL	SET_UP_BACK		;SET UP BACKGROUND IN BUFFER		CALL	GETLINES 		;GET EIGHT LINES		PUSH	BC			;SAVE LINES TO GO DATA		PUSH	HL 			;SAVE DECOMP ADDRESS		LD	A,(XYPOS)		;STORE STRIP IN NEXT DISPLAY		LD	C,A		LD	A,(XYPOS+1)		LD	B,A		LD	HL,CHRDATA		;LIST		LD	A,(ALLBITS)		CALL	PRINT_STRIP			LD	HL,XYPOS+1		;GET NEXT Y POSITION		INC	(HL)		POP	HL			;GET DECOMP DATA		POP	BC			;GET LINES TO GO		LD	A,C			;HAVE WE FINISHED		AND	A		JP	NZ,@LOOP		LD	A,(SPRWIDE)		;IF ONLY ONE SPRITE WIDE		DEC	A		RET	Z		LD	(SPRWIDE),A		;MORE THAN ONE ?		LD	A,(ORIGINY)		;RESET Y POS		LD	(XYPOS+1),A		LD	A,(OLDSKIPLINES)	;RESET SKIP		LD	(SKIPLINES),A		LD	C,8		LD	A,(MIR)		AND	A		JP	Z,@OK		LD	C,-8@OK		LD	A,(XYPOS)		ADD	A,C		LD	(XYPOS),A		JP	@MORE*****************************************        GET LINES INTO (CHRDATA)**	 HL = COMPRESSED DATA*        C  = TOTAL LINES*****************************************GETLINES	LD	A,(MIR)		AND	A		JP	NZ,GET_MIR		LD	DE,CHRDATA		LD	B,8@LOOP		PUSH	DE		PUSH	BC		LD	A,(SKIPLINES)		AND	A		JP	NZ,@SKIPSTUFF		CALL	DEC_LINE	;DECOMPRESS LINE		POP	BC		POP	DE		INC	DE		INC	DE		DEC	C		;HAVE WE FINISHED DECOMPRESSING		RET	Z		DEC	B		JP	NZ,@LOOP				RET@SKIPSTUFF	DEC	A		LD	(SKIPLINES),A		POP	BC		POP	DE		INC	DE		INC	DE		DEC	B		JP	NZ,@LOOP				RET*****************************************  DECOMPRESS ONE PIXEL LINE TO BUFFER**	 DE = DECOMPRESS AREA*        HL = COMPRESSED DATA*****************************************DEC_LINE	LD	A,(DISPFLAGS)		BIT	0,A		JP	NZ,ICE_LINE		BIT	1,A		JP	NZ,HATCH_LINE		BIT	2,A		JP	NZ,TWOCOL_LINE		LD	A,(HLI)			;GET BIT PATTERN DATA		LD	C,A			;IN C		LD	A,(ALLBITS)		;ADD MASK DATA		OR	C		LD	(ALLBITS),A@LOOP		LD	A,C		AND	A		RET	Z		SLA	C		JP	NC,@SKIP		LD	A,(HLI)			;GET MASK		LD	B,A		LD	A,(DE)		AND	B		OR	(HL)		LD	(DE),A		INC	HL		INC	E		LD	A,(DE)		AND	B		OR	(HL)		LD	(DE),A		INC	HL		DEC	E@SKIP		LD	A,E			;GOTO TO NEXT CHR		ADD	A,16		LD	E,A		JP	@LOOP*****************************************  DECOMPRESS ONE PIXEL LINE TO BUFFER**	 DE = DECOMPRESS AREA*        HL = COMPRESSED DATA*****************************************TWOCOL_LINE	LD	A,(HLI)			;GET BIT PATTERN DATA		LD	C,A			;IN C		LD	A,(ALLBITS)		;ADD MASK DATA		OR	C		LD	(ALLBITS),A@LOOP		LD	A,C		AND	A		RET	Z		SLA	C		JP	NC,@SKIP		LD	A,(HLI)			;GET MASK		LD	B,A		LD	A,(DE)		AND	B		LD	(DE),A		INC	HL		INC	E  			;STEP BACK TO LAST PLANE		LD	A,(DE)		AND	B		OR	(HL)		LD	(DE),A		INC	HL		DEC	E			;GET BACK TO FIRST PLANE@SKIP		LD	A,E			;GOTO TO NEXT CHR		ADD	A,16		LD	E,A		JP	@LOOP*****************************************  DECOMPRESS ONE PIXEL LINE TO BUFFER**	 DE = DECOMPRESS AREA*        HL = COMPRESSED DATA*****************************************HATCH_LINE	LD	A,(HATCH)		CPL		LD	(HATCH),A		LD	A,(HLI)			;GET BIT PATTERN DATA		LD	C,A			;IN C		LDZ	(REG1),A		LD	A,(ALLBITS)		;ADD MASK DATA		OR	C		LD	(ALLBITS),A@LOOP		LDZ	A,(REG1)		AND	A		RET	Z		SLA	A		LDZ	(REG1),A		JP	NC,@SKIP		LD	A,(HLI)			;GET MASK		LD	B,A		LD	A,(HATCH)		LD	C,A		LD	A,(HLI)		AND	C		LD	C,A		LD	A,(DE)		AND	B		OR	C		LD	(DE),A		INC	E		LD	A,(HATCH)		LD	C,A		LD	A,(HLI)		AND	C		LD	C,A		LD	A,(DE)		AND	B		OR	C		LD	(DE),A		DEC	E@SKIP		LD	A,E			;GOTO TO NEXT CHR		ADD	A,16		LD	E,A		JP	@LOOP*****************************************  DECOMPRESS ONE PIXEL LINE TO BUFFER*      FOR SUBZERO'S ICE PATTERN*	 DE = DECOMPRESS AREA*        HL = COMPRESSED DATA*****************************************ICE_LINE	LD	A,(HLI)			;GET BIT PATTERN DATA		LD	C,A			;IN C		LD	A,(ALLBITS)		;ADD MASK DATA		OR	C		LD	(ALLBITS),A		LD	A,C		LDZ	(REG1),A@LOOP		LDZ	A,(REG1)		AND	A		RET	Z		SLA	A		LDZ	(REG1),A		JP	NC,@SKIP		LD	A,(HLI)			;GET MASK		LD	B,A		CPL		LD	C,A		LD	A,(DE)		AND	B				OR	(HL)		LD	(DE),A		INC	HL		INC	E		LD	A,(DE)		AND	B		OR	C		LD	(DE),A		INC	HL		DEC	E@SKIP		LD	A,E			;GOTO TO NEXT CHR		ADD	A,16		LD	E,A		JP	@LOOP*****************************************        GET LINES INTO (CHRDATA)**	 HL = COMPRESSED DATA*        C  = TOTAL LINES*****************************************GET_MIR		LD	DE,CHRDATA+#70		LD	B,8@LOOP		PUSH	DE		PUSH	BC		LD	A,(SKIPLINES)		AND	A		JP	NZ,@SKIPSTUFF		CALL	DEC_MIR		;DECOMPRESS LINE		POP	BC		POP	DE		INC	DE		INC	DE		DEC	C		;HAVE WE FINISHED DECOMPRESSING		JP	Z,@EXIT		DEC	B		JP	NZ,@LOOP@EXIT		LD	A,(ALLBITS)		LD	E,A		LD	D,MIRTAB		LD	A,(DE)		LD	(ALLBITS),A				RET@SKIPSTUFF	DEC	A		LD	(SKIPLINES),A		POP	BC		POP	DE		INC	DE		INC	DE		DEC	B		JP	NZ,@LOOP		JP	@EXIT*****************************************  DECOMPRESS ONE PIXEL LINE TO BUFFER**	 DE = DECOMPRESS AREA*        HL = COMPRESSED DATA*****************************************DEC_MIR		LD	A,(DISPFLAGS)		BIT	0,A		JP	NZ,ICE_MIR		BIT	1,A		JP	NZ,HATCH_MIR		BIT	2,A		JP	NZ,TWOCOL_MIR		LD	A,(HLI)			;GET BIT PATTERN DATA		LD	C,A			;IN C		LD	A,(ALLBITS)		;ADD MASK DATA		OR	C		LD	(ALLBITS),A		LD	A,C		LDZ	(REG1),A		LD	B,MIRTAB@LOOP		LDZ	A,(REG1)		AND	A		RET	Z		SLA	A		LDZ	(REG1),A		JP	NC,@SKIP		LD	A,(HLI)			;GET MASK		LD	C,A		LD	A,(BC)		LD	C,A		PUSH	BC			;SAVE MASK		LD	A,(DE)		AND	C		LDZ	(REG2),A		;SAVE MASKED BGND		LD	A,(HLI)		LD	C,A		LD	A,(BC)		LD	C,A		LDZ	A,(REG2)		OR	C		LD	(DE),A				INC	E		POP	BC		LD	A,(DE)		AND	C		LDZ	(REG2),A		;SAVE MASKED BGND		LD	A,(HLI)		LD	C,A		LD	A,(BC)		LD	C,A		LDZ	A,(REG2)		OR	C		LD	(DE),A				DEC	E@SKIP		LD	A,E			;GOTO TO NEXT CHR		SUB	16		LD	E,A		JP	@LOOP*****************************************  DECOMPRESS ONE PIXEL LINE TO BUFFER**	 DE = DECOMPRESS AREA*        HL = COMPRESSED DATA*****************************************TWOCOL_MIR	LD	A,(HLI)			;GET BIT PATTERN DATA		LD	C,A			;IN C		LD	A,(ALLBITS)		;ADD MASK DATA		OR	C		LD	(ALLBITS),A		LD	A,C		LDZ	(REG1),A		LD	B,MIRTAB@LOOP		LDZ	A,(REG1)		AND	A		RET	Z		SLA	A		LDZ	(REG1),A		JP	NC,@SKIP		LD	A,(HLI)			;GET MASK		LD	C,A		LD	A,(BC)		LD	C,A		LD	A,(DE)		AND	C		LD	(DE),A				INC	HL		INC	E		LD	A,(DE)		AND	C		LDZ	(REG2),A		;SAVE MASKED BGND		LD	C,(HL)		LD	A,(BC)		LD	C,A		LDZ	A,(REG2)		OR	C		LD	(DE),A				DEC	E		INC	HL@SKIP		LD	A,E			;GOTO TO NEXT CHR		SUB	16		LD	E,A		JP	@LOOP*****************************************  DECOMPRESS ONE PIXEL LINE TO BUFFER*      WITH CROSS HATCH PATTERN**	 DE = DECOMPRESS AREA*        HL = COMPRESSED DATA*****************************************HATCH_MIR	LD	A,(HLI)			;GET BIT PATTERN DATA		LD	C,A			;IN C		LD	A,(ALLBITS)		;ADD MASK DATA		OR	C		LD	(ALLBITS),A		LD	A,(HATCH)		CPL		LD	(HATCH),A		LD	A,C		LDZ	(REG1),A		LD	B,MIRTAB@LOOP		LDZ	A,(REG1)		AND	A		RET	Z		SLA	A		LDZ	(REG1),A		JP	NC,@SKIP		LD	A,(HLI)			;GET MASK		LD	C,A		LD	A,(BC)		LD	C,A		PUSH	BC			;SAVE MASK		LD	A,(DE)		AND	C		LDZ	(REG2),A		;SAVE MASKED BGND		LD	A,(HATCH)		;ADD HATCH		LD	C,A		LD	A,(HLI)		AND	C		LD	C,A		LD	A,(BC)		LD	C,A		LDZ	A,(REG2)		OR	C		LD	(DE),A				INC	E		POP	BC		LD	A,(DE)		AND	C		LDZ	(REG2),A		;SAVE MASKED BGND		LD	A,(HATCH)		;ADD HATCH		LD	C,A		LD	A,(HLI)		AND	C		LD	C,A		LD	A,(BC)		LD	C,A		LDZ	A,(REG2)		OR	C		LD	(DE),A				DEC	E@SKIP		LD	A,E			;GOTO TO NEXT CHR		SUB	16		LD	E,A		JP	@LOOP*****************************************  DECOMPRESS ONE PIXEL LINE TO BUFFER*      FOR SUBZERO'S ICE PATTERN**	 DE = DECOMPRESS AREA*        HL = COMPRESSED DATA*****************************************ICE_MIR		LD	A,(HLI)			;GET BIT PATTERN DATA		LD	C,A			;IN C		LD	A,(ALLBITS)		;ADD MASK DATA		OR	C		LD	(ALLBITS),A		LD	A,C		LDZ	(REG1),A		LD	B,MIRTAB@LOOP		LDZ	A,(REG1)		AND	A		RET	Z		SLA	A		LDZ	(REG1),A		JP	NC,@SKIP		LD	A,(HLI)			;GET MASK		LD	C,A  			;MIRROR IT		LD	A,(BC)					LD	C,A			;PUT MIRE MASK IN C		PUSH	BC			;SAVE MASK		LD	A,(DE)			;GET BAKGND					AND	C			;MASK OFF BAKGND		LDZ	(REG2),A		;SAVE MASKED BAKGND		LD	A,(HLI)			;GET SPR DATA		LD	C,A			;IN C		LD	A,(BC)			;MIRROR IT		LD	C,A			;TO C		LDZ	A,(REG2)		;GET MASKED BAKGND		OR	C			;PUT MIRRORED SPR DATA OVER		LD	(DE),A			;PUT IT ON THE BAKGND     		INC	E		POP	BC			;RETREIVE MASK DATA		INC	HL		LD	A,C		CPL		LDZ	(REG2),A		LD	A,(DE)			;GET BAKGND		AND	C			;MASK OFF BAKGND		LD	C,A		LDZ	A,(REG2)		OR	C			LD	(DE),A			;PUT IT ON THE BAKGND     			DEC	E@SKIP		LD	A,E			;GOTO TO NEXT CHR		SUB	16		LD	E,A		JP	@LOOP*****************************************	 SET UP BACKGROUND DATA****************************************SET_UP_BACK	PUSH	BC		PUSH	HL		LD	A,(XYPOS)		LD	C,A		LD	A,(XYPOS+1)		SUB	64		LD	B,A		CALL	LOCBAKPOS		LD	DE,CHRDATA		LD	B,8@LOOP		PUSH	HL		PUSH	BC		LD	A,(HL)		CALL	COPYCHR		POP	BC		POP	HL		INC	HL		DEC	B		JP	NZ,@LOOP		POP	HL		POP	BC		RET*****************************************	   COPY CHR A TO DE****************************************COPYCHR		CP	STARTSPR	;IS THIS A PART OF THE BACKGROUND		JP	NC,COPYVDP	;IF NOT COPY FROM VDP		LD	L,A		LD	H,0		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		LD	BC,CHRRAM		ADD	HL,BC		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		LD	A,(HLI)		LD	(DE),A		INC	E		RET*****************************************      COPY CHR A FROM VDP TO DE****************************************COPYVDP		PUSH	DE		LD	H,MULL		;H & D = MULTAB		LD	L,A		;A = TAB ADDRESS		LD	A,(HL)				INC	H		LD	H,(HL)		;DE = A * 16 + 8000H		LD	L,A		POP	DE		;COPY FROM HL => DE		DO	4			CALL	WAIT1		;WAIT FOR CORRECT TIME		LD	A,(HLI)		LD	(DE),A		INC	DE		LD	A,(HLI)		LD	(DE),A		INC	DE		CALL	WAIT1		;WAIT FOR CORRECT TIME		LD	A,(HLI)		LD	(DE),A		INC	DE		LD	A,(HLI)		LD	(DE),A		INC	DE		LOOP		RET*********************************************************************************		          STRIP DATA CONTROLLER*************************************************************************************************************************      DELETE STRIPS ON BACK MAP****************************************DEL_STRIPS		LD	HL,UNDERDATA@DELLOOP	LD	A,(HLI)			;GET PATTERN DATA		AND	A		RET	Z		LDZ	(REG1),A		;E HOLD PATTERN		LD	A,(HLI)			;X COORD		LD	C,A		LD	A,(HLI)			;Y COORD		SUB	64		LD	B,A		PUSH	HL			;SAVE SPRITE ADDRESS		CALL	LOCBAKPOS		LD	D,H		LD	E,L		POP	HL		LDZ	A,(REG1)		LD	C,A@LOOP		LD	A,C		AND	A		JP	Z,@DELLOOP		AND	#80		JP	Z,@NOBIT		LD	A,(HLI)		CP	BLANKCHR		;IF THIS CHR IS THE BLANK		JP	Z,@NOBIT		;THEN DON'T PLOT OVER		CP	STARTSPR		;IF THIS CHR WAS'NT PART		JP	NC,@NOBIT		;OF THE ORIGNAL BAKGND						;DON'T PLOT OVER IT.		LD	(DE),A@NOBIT		SLA	C		INC	DE	  		;NEXT BACKGND POS		JP	@LOOP*****************************************         PRINT STRIP ON BACKGROUND**     HL = CHARACTER BLOCK TO READ*       BC = XY POSTION OF STRIP*          A = PATTERN DATA****************************************MAXSPRS		EQU	(255-STARTSPR)-8PRINT_STRIP	AND	A			;IF PATTERN DATA IS EMPTY		RET	Z			;THEN RETURN		LD	E,A		LD	A,B			;CLIP GREATER THAN 18		CP	64+18		RET	NC		CP	64			;OFF THE TOP OF THE SCREEN		RET	C		LD	A,E			;PATTERN		LDZ	(REG1),A		;E HOLD PATTERN		CALL	PUT_UNDERDATA		LD	A,C		LDZ	(REGX),A		CALL	PUT_UNDERDATA		LD	A,B		LDZ	(REGY),A		CALL	PUT_UNDERDATA		PUSH	HL		LD	A,B			;MAKE SCR COORDS CORRECT		SUB	64		LD	B,A		CALL	LOCBAKPOS		LD	B,H			;BC = MAP ADDRESS		LD	C,L		POP	HL@LOOP		LDZ	A,(REG1)		AND	A		RET	Z			;RETURN IF NO MORE STRIP		AND	#80			;GET BIT 7 OF DATA		JP	Z,@NONE			;NO DATA HERE		PUSH	HL		CALL	PUT_CHR		POP	HL@NONE		LDZ	A,(REG1)		;SHIFT DATA		SLA	A		LDZ	(REG1),A		LD	A,L			;GET TO NEXT CHR		ADD	A,16		LD	L,A		LDZ	A,(REGX)		;GET NEXT XPOS		INC	A		LDZ	(REGX),A		INC	BC			;NEXT MAP POSITION		JP	@LOOP*****************************************	PUT A CHR ON THE SCREEN****************************************PUT_CHR		;LD	A,(BC)			;GET UNDER DATA		;CP	STARTSPR		;JP	C,@NOCOL		;LD	A,(COLLISIONS)		;INC	A				;LD	(COLLISIONS),A				;@NOCOL		LD	A,(BC)		LD	E,A		CALL	PUT_UNDERDATA		LD	A,(BC)	   		;IF CHR IS ALREADY IN BACKGROUND		CP	STARTSPR		;THEN DONT'T GET A SPARE		JP	NC,@NOSPARE		;ARL 05/04/93		CALL	GETSPARE		;GET A SPARE SPRITE		JP	C,@NOMORE		;JUMP IF NO MORE SPRITES		LD	(BC),A			;PUT CHR ON BAK SCREEN@NOSPARE	CALL	TEST_COLL		;DO COLLISION TESTS		PUSH	BC			;SAVE SCREEN POS		CALL	COPYSPR			;COPY DATA AT HL = CHR A			POP	BC			;RESTORE SCREEN POS		RET@NOMORE		LD	A,(BC)		LDZ	(REG4),A		LD	A,BLANKCHR			;CLEAR OUT CHR POS		LD	(BC),A			;WITH A BLANK CHR				PUSH	BC			;SAVE BACKSCR POS		LDZ	A,(REGY)		LD	B,A		LDZ	A,(REGX)		LD	C,A			CALL	WINDOW_X		;SPRITE WINDOWING		JP	C,@NOTONSCR		;IF SPRITE NOT ON SCREEN JMP		CALL	GETSPARE_HARD		;GET A SPARE SPRITE		CALL	PUT_OBJ		CALL	COPYHARDSPR		;COPY DATA AT HL = CHR A			POP	BC		RET@NOTONSCR	POP	BC		LDZ	A,(REG4)		LD	(BC),A		RET*****************************************	  GET SPARE SPRITE****************************************GETSPARE	LD	DE,SPARECHRS		;GET AMOUNT OF SPARES LEFT		LD	A,(DE)		AND	A		JP	Z,@NOCHRS		;JUMP IF NONE LEFT		DEC	A			;TAKE ONE CHR		LD	(DE),A		LD	A,(NEXTSPR)		;GET SPARE SPRITE		LD	D,A		INC	A		CP	STARTSPR		JP	NC,@1		LD	A,STARTSPR@1		LD	(NEXTSPR),A		;MOVE TO NEXT SPRITE POS		LD	A,D		OR	A		RET@NOCHRS		SCF		RET*****************************************     GET SPARE HARDWARE SPRITE****************************************GETSPARE_HARD	LD	A,(HARDSPR)		;GET SPARE SPRITE		LD	D,A		INC	A			AND	127		LD	(HARDSPR),A		;MOVE TO NEXT SPRITE POS		LD	A,D		RET*****************************************	   STORE BYTES TO OAM****************************************PUT_OBJ		PUSH	HL		LDZ	(REG2),A		LD	H,>OBJRAM		LD	A,(OBJPTR)		LD	L,A		LD	(HL),B		INC	L		LD	(HL),C		INC	L		LDZ	A,(REG2)		LD	(HL),A		INC	L		LD	A,(OBJFLAGS)		;%00001111		LD	(HL),A		INC	L		LD	A,L		LD	(OBJPTR),A		LDZ	A,(REG2)		POP	HL		RET*****************************************	     WINDOW SPRITE*	     ~~~~~~~~~~~~~*IN:	  BC = SPRITE CHARPOS*OUT:     BC = SPRITE REAL POS**      CYSET IF SPRITE OFF SCREEN****************************************WINDOW_X	PUSH	HL		INC	B		INC	B		INC	B		SLA	B		SLA	B		SLA	B		LD	A,(SHAKE_Y)		;MAKE SPRITES MOVE WITH JUDDER		SUB	8		ADD	A,B		LD	B,A		LD	HL,XPOS		LD	A,(HLI)		LD	H,(HL)		SRL	H		RRA		SRL	H		RRA		SRL	H		RRA			;A = LEFT SIDE CHR X		INC	C		CP	C		;IS C BEFORE THE LEFT SIDE OF SCREEN		JP	NC,@OFFSCR	;JUMP IF IT IS.		DEC	C		ADD	A,20		;ADD TO RIGHT SIDE OF SCREEN		CP	C	  	;IS IT PAST THERE		JP	C,@OFFSCR	;JUMP IF IT IS.			SUB	20		;RESTORE ORIGIN		LD	H,A		LD	A,C		;GET X - ORIGIN		SUB	H		;TO GIVE SCREEN COORDS		SLA	A		;MAKE SPRITE COORD ON CHR BOUND		SLA	A		SLA	A		LD	C,A		LD	A,(XPOS)		CPL		AND	7		ADD	A,C		LD	C,A		INC	C		POP	HL		OR	A		RET@OFFSCR		POP	HL		SCF		RET*****************************************	     WINDOW X POS*	     ~~~~~~~~~~~~*      CYSET IF SPRITE OFF SCREEN****************************************ONSCR_X		PUSH	HL		LD	HL,XPOS		LD	A,(HLI)		LD	H,(HL)		SRL	H		RRA		SRL	H		RRA		SRL	H		RRA		CP	C		;IS C BEFORE THE LEFT SIDE OF SCREEN		JP	NC,@OFFSCR	;JUMP IF IT IS.		ADD	A,20		;ADD TO RIGHT SIDE OF SCREEN		CP	C	  	;IS IT PAST THERE		JP	C,@OFFSCR	;JUMP IF IT IS.		SUB	20		;RESTORE ORIGIN		LD	H,A		LD	A,C		;GET X - ORIGIN		SUB	H		;TO GIVE SCREEN COORDS		LD	C,A		POP	HL		OR	A		RET@OFFSCR		LD	A,128		POP	HL		SCF		RET*****************************************	   TEST FOR COLLISION*       BC POINTS TO BACKGROUND*	   A = NEW CHAR PLOTED*          E = OLD CHAR****************************************TEST_COLL	PUSH	BC		LD	B,A			;SAVE NEW CHR		LD	D,>COLTAB		;GET COLLISION STATUS		LD	A,(DE)			;OF OLD CHAR		LD	C,A		LD	A,(SPRNUMBIT)		;PLACE THIS SPRITES BITS		OR	C			;IN COLLISION FLAGS			   			LD	E,B			;PROPAGATE FLAGS TO NEW CHR		LD	(DE),A		LD	A,B		POP	BC     		RET*****************************************	 STORE BYTES STRIP DATA****************************************PUT_UNDERDATA	PUSH	HL		PUSH	DE		LD	HL,UNDERPTR		LD	E,(HL)		INC	HL		LD	D,(HL)		LD	(DE),A		INC	DE				LD	(HL),D		DEC	HL		LD	(HL),E		POP	DE		POP	HL		RET*****************************************           CLEAR OUT COLTAB****************************************CLR_COLTAB	LD	HL,COLTAB		LD	B,16		XOR	A@LOOP		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		DJNZ	@LOOP		RET*********************************************************************************		             STRIP SPRITES*************************************************************************************************************************         PRINT STRIP OF SPRITES**     HL = CHARACTER BLOCK TO READ*       BC = XY POSTION OF STRIP*          E = PATTERN DATA****************************************STRIP_SPRITE	LD	A,B			;CLIP GREATER THAN 18		CP	64+18		RET	NC		SUB	64		RET	C		LD	B,A		LD	A,E			;PATTERN		LDZ	(REG1),A		;E HOLD PATTERN@LOOP		LDZ	A,(REG1)		AND	A		RET	Z			;RETURN IF NO MORE STRIP		AND	#80			;GET BIT 7 OF DATA		JP	Z,@NONE			;NO DATA HERE		PUSH	HL		PUSH	BC			;SAVE CHR XY				CALL	WINDOW_X		;SPRITE WINDOWING		JP	C,@NOTONSCR		;IF SPRITE NOT ON SCREEN JMP		CALL	GETSPARE_HARD		;GET A SPARE SPRITE		CALL	PUT_OBJ		CALL	COPYHARDSPR		;COPY DATA AT HL = CHR A	@NOTONSCR	POP	BC		POP	HL@NONE		LDZ	A,(REG1)		;SHIFT DATA		SLA	A		LDZ	(REG1),A		LD	A,L			;GET TO NEXT CHR		ADD	A,16		LD	L,A		INC	C			;GET NEXT SPR POSITION		JP	@LOOP*****************************************	   SET UP VARIABLES****************************************SET_VARS	LD	HL,UNDERPTR		LD	DE,UNDERDATA		LD	(HL),E		INC	HL		LD	(HL),D			XOR	A		LD	(COLLISIONS),A		LD	A,(NEXTSPR)		LD	(COLSTART),A		LD	A,80		LD	(SPARECHRS),A		RET*****************************************	   CLEAR OBJECT TABLE****************************************CLR_OBJECTS	LD	HL,OBJPTR		LD	DE,OBJRAM		LD	(HL),E		INC	HL		LD	(HL),D			LD	HL,OBJRAM		LD	B,40		XOR	A@LOOP		CALL	WAIT1		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		DJNZ	@LOOP		RET*****************************************          SCAN FOR COLLISIONS*	   ~~~~~~~~~~~~~~~~~~~*	   A = COLLISION MATCH*	       CYSET HIT****************************************SCAN_COL	LD	E,A		;TEST BITS		LD	H,>COLTAB		LD	A,(COLSTART)	;START TO WHERE TO SEARCH		LD	L,A		LD	A,(NEXTSPR)	;WHERE TO FINISH SEARCH		LD	C,A@LOOP		LD	A,L		;IS THIS THE END OF THE SEARCH		CP	C		JP	Z,@ENDOFTAB	;JUMP IF YES		LD	A,(HL)		;GET ENTRY IN TABLE		AND	E		CP	E		JP	Z,@HIT				LD	A,L		INC	A		CP	STARTSPR		JP	NC,@1		LD	A,STARTSPR@1		LD	L,A		JP	@LOOP@ENDOFTAB	OR	A		RET@HIT		SCF		RET*****************************************          SCAN FOR COLLISIONS*	   ~~~~~~~~~~~~~~~~~~~*	   A = COLLISION MATCH*	       CYSET HIT****************************************SCAN_COL2	LD	E,A		;TEST BITS		LD	H,>COLTAB		LD	L,0@LOOP		LD	A,(HL)		;GET ENTRY IN TABLE		AND	E		CP	E		JP	Z,@HIT				DEC	L		JP	NZ,@LOOP		OR	A		RET@HIT		SCF		RET****************************************      PUT BACKGROUND IN A SPRITE*             SPR A TO HL ****************************************READSPR		PUSH	DE		PUSH	HL		LD	H,MULL		;H & D = MULTAB		LD	L,A		;A = TAB ADDRESS		LD	E,(HL)				INC	H		LD	D,(HL)		;DE = A * 16 + 8000H		POP	HL		;COPY FROM HL => DE		DO	4			CALL	WAIT1		;WAIT FOR CORRECT TIME		LD	A,(DE)		LD	(HLI),A		INC	DE		LD	A,(DE)		LD	(HLI),A		INC	DE		CALL	WAIT1		;WAIT FOR CORRECT TIME		LD	A,(DE)		LD	(HLI),A		INC	DE		LD	A,(DE)		LD	(HLI),A		INC	DE		LOOP		POP	DE		;DE PRESERVED				RET*****************************************      PUT BACKGROUND IN A SPRITE*         HL TO A = SPRITE CHAR ****************************************COPYSPR		PUSH	DE		PUSH	HL		LD	H,MULL		;H & D = MULTAB		LD	L,A		;A = TAB ADDRESS		LD	E,(HL)				INC	H		LD	D,(HL)		;DE = A * 16 + 8000H		POP	HL		;COPY FROM HL => DE		DO	4			CALL	WAIT1		;WAIT FOR CORRECT TIME		LD	A,(HLI)		LD	(DE),A		INC	DE		LD	A,(HLI)		LD	(DE),A		INC	DE		CALL	WAIT1		;WAIT FOR CORRECT TIME		LD	A,(HLI)		LD	(DE),A		INC	DE		LD	A,(HLI)		LD	(DE),A		INC	DE		LOOP		POP	DE		;DE PRESERVED				RET*****************************************       PUT DATA IN TO SPRITE CHARS*         HL TO A = SPRITE CHAR ****************************************COPYHARDSPR	PUSH	DE		PUSH	HL		LD	H,0		;H & D = MULTAB		LD	L,A		;A = TAB ADDRESS		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		SET	7,H		LD	D,H		LD	E,L		POP	HL		;COPY FROM HL => DE		DO	4			CALL	WAIT1		;WAIT FOR CORRECT TIME		LD	A,(HLI)		LD	(DE),A		INC	DE		LD	A,(HLI)		LD	(DE),A		INC	DE		CALL	WAIT1		;WAIT FOR CORRECT TIME		LD	A,(HLI)		LD	(DE),A		INC	DE		LD	A,(HLI)		LD	(DE),A		INC	DE		LOOP		POP	DE		;DE PRESERVED				RET***************************************** WAIT FOR CORRECT TIME TO PUT ON CHRS****************************************WAIT_STAT	PUSH	AF@WAIT		LD	A,(STAT)		AND	2		JP	Z,@WAIT@WAIT2		LD	A,(STAT)		AND	2		JP	NZ,@WAIT2		POP	AF   		RET***************************************** WAIT FOR CORRECT TIME TO PUT ON CHRS****************************************WAIT1@W1		LDZ	A,(STAT)		AND	2		JP	NZ,@W1		RET*****************************************       WAIT FOR FRAME FLYBACK****************************************WAIT_FLY	PUSH	AF				XOR	A		LD	(VBLFLAG),A@WAIT		LD	A,(VBLFLAG)		AND	A		JP	Z,@WAIT		XOR	A		LD	(VBLFLAG),A@FUCKIT		POP	AF		RET*****************************************       WAIT FOR FRAME FLYBACK****************************************WAIT_FLY2	PUSH	AF@WAIT		LDZ	A,(LY)		CP	140		JP	NZ,@WAIT		LD	A,50@WAIT2		DEC	A		JP	NZ,@WAIT2		POP	AF		RET*****************************************	   CLEAR BOTH SCREENS****************************************CLS		CALL	CLR_OBJECTS		CALL	SET_DMA_TRANS		CALL	WAIT_FLY 		XOR	ACLS_FILL	LD	HL,#9800		LD	B,0@LOOP		CALL	WAIT_STAT		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A     		CALL	WAIT_STAT		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A		LD	(HLI),A			DJNZ	@LOOP		RET*****************************************	  COPY CHARS TO CHRMEM*          HL = VDP ADDRESS TO COPY*          DE = CHARS TO COPY*          BC = NUMBER OF CHRS*	    A = BANK NUM****************************************COPY_VDP	SETBANK		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		SET	7,H		JP	COPYCH	*****************************************	DECOMPRESS CHARS TO CHRRAM*          HL = ADDRESS OF PACKED CHRS*	    A = BANK NUM****************************************DECOMP_CHR	SETBANK		LD	DE,CHRRAM+16		CALL	UNPACK		LD	HL,CHRRAM	;CLEAR OUT CHR 0		LD	BC,16@LOOP		LD	(HL),0		INC	HL		DEC	BC		LD	A,B		OR	C		JP	NZ,@LOOP		LD	DE,CHRRAM		LD	BC,64		;64 CHARS		JP	COPY_CHR_BC	   *****************************************	  COPY CHARS TO CHRMEM*          DE = CHARS TO COPY*          BC = NUMBER OF CHRS*	    A = BANK NUM****************************************COPY_CHR	SETBANK		LD	(CHRBANK),A	;SET CURRENT CHR BANK		LD	A,E		LD	(CHRADDL),A		LD	A,D		LD	(CHRADDH),ACOPY_CHR_BC	LD	HL,#9000COPYCH		SLA	C		RL	B		@LOOP		CALL	WAIT_STAT	;ONLY WORK IN V-BLANK		LD	A,(DE)			LD	(HLI),A		INC	DE		LD	A,(DE)			LD	(HLI),A		INC	DE		LD	A,(DE)			LD	(HLI),A		INC	DE		LD	A,(DE)			LD	(HLI),A		INC	DE		LD	A,(DE)			LD	(HLI),A		INC	DE		LD	A,(DE)			LD	(HLI),A		INC	DE		LD	A,(DE)			LD	(HLI),A		INC	DE		LD	A,(DE)			LD	(HLI),A		INC	DE		DEC	BC		LD	A,B		OR	C		JP	NZ,@LOOP		RET*****************************************	     SET XPOS WITH DE****************************************SETXPOS		LD	A,D		CP	#FF		JP	NZ,@OK		LD	DE,0@OK		LD	HL,-352		ADD	HL,DE		JP	NC,@OK1		LD	DE,351@OK1		LD	HL,XPOS		LD	(HL),E		INC	HL		LD	(HL),D		RET				*****************************************        SET X CENTER ON SCROLL****************************************SETCENTER	LD	A,(CENTERX)		; A = 0 - 64		SUB	10		JP	NC,@1		XOR	A@1		LD	E,A		LD	D,0		SLA	E		RL	D		SLA	E		RL	D		SLA	E		RL	D		;X POS FOR NEW X		LD	A,(XPOS)	;HIGH OF XPOS		LD	L,A		LD	A,E		SUB	L		LD	E,A		LD	A,(XPOS+1)		LD	L,A		LD	A,D		SBC	A,L		LD	D,A;SHIFT DIFF		SRA	D		RR	E;ADD DIFF		LD	A,(XPOS)		ADD	A,E		LD	E,A		LD	A,(XPOS+1)		ADC	A,D		LD	D,A		JP	SETXPOS	*****************************************	DECOMPRESS MAP TO MAPRAM*	   HL = MAP TO COPY****************************************DECOMP_MAP	SETBANK		LD	DE,MAPRAM		CALL	UNPACK		LD	HL,MAPRAM		;ADD 1 TO ALL MAP POSITIONS		LD	BC,64*18@LOOP		LD	A,(HL)		INC	A		LD	(HLI),A		DEC	BC		LD	A,B		OR	C		JP	NZ,@LOOP		RET*****************************************	   COPY MAP TO DATA*	   HL = MAP TO COPY****************************************COPYMAP		SETBANK		LD	DE,MAPRAM		LD	BC,64*18@LOOP		LD	A,(HLI)		LD	(DE),A		INC	DE		DEC	BC		LD	A,B		OR	C		JP	NZ,@LOOP		RET*****************************************	   PRINT BACK SCREEN****************************************PRSCR		LD	A,(SHAKE_Y)		LDZ	(WY),A		LD	HL,XPOS		LD	A,(HL)		AND	7		XOR	7		LDZ	(WX),A		;SCX		LD	A,(HLI)		LD	H,(HL)		LD	L,A		SRL	H		RR	L			SRL	H		RR	L			SRL	H		RR	L				     		LD	DE,MAPRAM		ADD	HL,DE		LD	DE,BGPOS			LD	C,17			;LEAVE ROOM FOR PANEL WAS 18@MAIN		PUSH	BC		DO	10		CALL	WAIT1		LD	A,(HLI)		LD	(DE),A		INC	DE		LD	A,(HLI)		LD	(DE),A		INC	DE		LOOP		CALL	WAIT1			;GORO FIX 13/6/93		LD	A,(HLI)		LD	(DE),A		INC	DE		LD	A,E		ADD	A,11		LD	E,A		JP	NC,@NOINC		INC	D@NOINC		LD	BC,64-21		ADD	HL,BC		POP	BC		DEC	C		JP	NZ,@MAIN		;EI		RET		*****************************************         SET WINDOWED SCREEN****************************************SETUPPANEL	LD	HL,#9C00		LD	C,PANELCHR		LD	B,20@LOOP		CALL	WAIT1		LD	A,C		LD	(HLI),A		INC	C		DJNZ	@LOOP		XOR	A		CALL	PRINTPANEL		DB	"                    ",0		CALL	LEFT_NAME		CALL	RIGHT_NAME		CALL	DISPPANEL		LD	A,FULL_STRENGTH		LD	(SPRENERGY0),A		LD	(SPRENERGY1),A		XOR	A		LD	(ENERGY0),A		LD	(ENERGY1),A		LD	B,31@LOOP2		PUSH	BC		CALL	MOVESLIDES		POP	BC		DJNZ	@LOOP2		LD	A,99		LD	(GAMETIME),A		CALL	PRINTTIME		RET*****************************************         SET WINDOWED SCREEN****************************************UPDATEPANEL	XOR	A		CALL	PRINTPANEL		DB	"                    ",0		CALL	LEFT_NAME		CALL	RIGHT_NAME		CALL	DISPPANEL		XOR	A		LD	(ENERGY0),A		LD	(ENERGY1),A		LD	B,31@LOOP2		PUSH	BC		CALL	MOVESLIDES		POP	BC		DJNZ	@LOOP2		RET*****************************************	      FIND NAME DATA****************************************PLAYNAMES	DB	4,"CAGE    "	;0		DB	4,"KANO    "	;1		DB	6,"RAYDEN  "	;2		DB	4,"KANG    "	;3		DB	8,"SCORPION"	;4		DB	7,"SUBZERO "	;5		DB	5,"SONYA   "	;6		DB	4,"GORO    "	;7		DB	5,"TSUNG   "	;8		DB	7,"MATCHES "	;9		DB	5,"PAIRS   "	;10		DB	5,"MATCH   "	;11		DB	6,"MIRROR  "	;12		DB	11,"BATTLE PLAN" ;13PLAYNAME2	DB	4,"JEAN    "	;0		DB	3,"BOB     "	;1		DB	4,"ERIC    "	;2		DB	4,"CARL    "	;3		DB	5,"PETER   "	;4		DB	4,"GARY    "	;5		DB	6,"FERGUS  "	;6		DB	4,"GORO	   "	;7		DB	4,"EDDY    "	;8		DB	7,"MATCHES "	;9		DB	5,"PAIRS   "	;10		DB	5,"MATCH   "	;11		DB	6,"MIRROR  "	;12		DB	12,"BRITTLE PLUM" ;13FINDNAME	PUSH	BC		LD	L,A			;GET HL * 9		LD	H,0		LD	C,L		LD	B,H		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		ADD	HL,BC		LD	BC,PLAYNAMES		LD	A,(GOROFLAG)		AND	A		JP	Z,@OK		LD	BC,PLAYNAME2@OK		ADD	HL,BC		POP	BC      		RET*****************************************           PRINT LEFT NAME****************************************LEFT_NAME	LD	DE,PANELBUF		LD	A,(BASE0)				CALL	FINDNAME		LD	B,(HL)			INC	HL	@LOOP		LD	A,(HLI)		LD	(DE),A		INC	DE		DJNZ	@LOOP     		RET*****************************************           PRINT RIGHT NAME****************************************RIGHT_NAME	LD	A,(BASE1)		CALL	FINDNAME		LD	A,(HL)		PUSH	AF		CPL		INC	A		LD	C,A		RLA		SBC	A,A		LD	B,A		INC	HL		LD	D,H		LD	E,L		LD	HL,PANELBUF+20		ADD	HL,BC				POP	AF		LD	B,A@LOOP		LD	A,(DE)		LD	(HLI),A		INC	DE		DJNZ	@LOOP     		RET*****************************************	      MOVE SLIDES****************************************MOVESLIDES	LD	A,(SPRENERGY0)		LD	C,A	  	LD	A,(ENERGY0)		CP	C		JP	Z,@SAME1		CALL	MSLIDE		LD	(ENERGY0),A		CALL	LEFTSLIDE@SAME1		LD	A,(SPRENERGY1)		LD	C,A		LD	A,(ENERGY1)		CP	C		RET	Z		CALL	MSLIDE		LD	(ENERGY1),A		JP	RIGHTSLIDE*****************************************	    MOVE ONE SLIDER****************************************MSLIDE		CP	C		RET	Z		JP	C,@UP		DEC	A		RET@UP		INC	A		RET*****************************************           PRINT LEFT SLIDER****************************************SHIFTL		DB	3,2,1,0LEFTSLIDE	LD	A,(ENERGY0)		AND	A		JP	Z,@CLR		LD	C,A		;STORE LEN		AND	3		;FIND CORRECT SHIFT CHR		LD	E,A		LD	D,0		LD	HL,SHIFTL		ADD	HL,DE		LD	D,(HL)		;CHAR TO USE IN E		LD	A,C		SRL	A		SRL	A		;A POSITION IN SLIDER		PUSH	AF		CALL	PAN_OVER_TEXT		POP	AF		INC	A		LD	D,7		CALL	PAN_OVER_TEXT		RET@CLR		XOR	A		LD	D,7		CALL	PAN_OVER_TEXT		RET    	*****************************************           PRINT RIGHT SLIDER****************************************SHIFTR		DB	4,5,6,0RIGHTSLIDE	LD	A,(ENERGY1)			AND	A		JP	Z,@CLR		LD	C,A		;STORE LEN		AND	3		;FIND CORRECT SHIFT CHR		LD	E,A		LD	D,0		LD	HL,SHIFTR		ADD	HL,DE		LD	D,(HL)		;CHAR TO USE IN E		LD	A,C		SRL	A		SRL	A		LD	C,A		LD	A,19		SUB	C		PUSH	AF		CALL	PAN_OVER_TEXT		POP	AF		DEC	A		LD	D,7		CALL	PAN_OVER_TEXT		RET@CLR		LD	A,19		LD	D,7		CALL	PAN_OVER_TEXT		RET    	*****************************************         COPY DATA TO PANELBUF*	    DE = DATA ADDRESS*	 A = START POS IN PANEL*          TERMINATE WITH A ZERO****************************************COPYPANEL	LD	C,A		LD	B,0		LD	HL,PANELBUF		ADD	HL,BC@LOOP		LD	A,(DE)		AND	A		RET	Z		LD	(HLI),A		INC	DE		JP	@LOOP*****************************************           PRINT TO PANELBUF*             A = START POS*         TERMINATE WITH A ZERO****************************************PRINT		XOR	APRINTPANEL	POP	DE		LD	C,A		LD	B,0		LD	HL,PANELBUF		ADD	HL,BC@LOOP		LD	A,(DE)		AND	A		JP	Z,@END		LD	(HLI),A		INC	DE		JP	@LOOP@END		INC	DE		PUSH	DE		JP	DISPPANEL*****************************************         COPY DATA TO PANELBUF*	    DE = DATA ADDRESS*	 A = START POS IN PANEL*          TERMINATE WITH A ZERO****************************************DISPPANEL	LD	HL,PANELBUF		LD	B,20		LD	C,0@LOOP		LD	A,(HLI)		LD	E,A		LD	D,7		PUSH	HL		PUSH	BC		LD	A,C		CALL	WRITE_PAN				POP	BC		POP	HL		INC	C		DJNZ	@LOOP		RET*****************************************        PRINT SLIDER UNDER TEXT*	     D = SLIDE CHR*	   A = PANEL POSITION****************************************PAN_OVER_TEXT	LD	C,A		LD	B,0		LD	HL,PANELBUF		ADD	HL,BC		LD	E,(HL)			;GET UNDER CHR		JP	WRITE_PAN*****************************************WRITE TO A BACKGROUND CHR IN THE PANEL*    D = CHR1 : E = CHR2 : A = XPOS **         CHR1 = SLIDE CHR NUM*         CHR2 = CHRSET NUM****************************************WRITE_PAN	ADD	A,PANELCHR		LD	L,A		LD	H,MULL		LD	A,(HL)		INC	H		LD	H,(HL)		LD	L,A		LD	A,1		SETBANK		PUSH	HL		;PUSH VDP POS		LD	L,D		LD	H,0		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		LD	BC,SLIDECHR		ADD	HL,BC		PUSH	HL  		;PUSH SLIDE CHR		LD	A,E		SUB	32		LD	L,A		LD	H,0		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		LD	BC,CHRSET		ADD	HL,BC		POP	DE		;GET SLIDE		POP	BC		;GET VDP POS		LD	A,8@LOOP		PUSH	AF		CALL	WAIT1				LD	A,(DE)		OR	(HL)		LD	(BC),A		INC	BC		INC	DE		CALL	WAIT1		LD	A,(DE)		OR	(HL)		LD	(BC),A		INC	BC		INC	DE		INC	HL		POP	AF		DEC	A		JP	NZ,@LOOP		RET*****************************************		DEC TIME****************************************DEC_TIME	LD	A,(CLOCK_OFF)		AND	A		RET	NZ		LD	A,(TIME)		AND	3		RET	NZ		LD	HL,GAMETIME		LD	A,(HL)		AND	A		JP	Z,PRINTTIME		DEC	(HL)		JP	PRINTTIME*****************************************	     PRINT A NUMBER*        C = START POS IN PANEL****************************************PRINTTIME	LD	A,(GAMETIME)		LD	L,A		LD	H,0		LD	C,9		JP	NUM2*****************************************	     PRINT A NUMBER*        C = START POS IN PANEL****************************************NUM5		LD	DE,-10000		CALL	DIGITNUM4		LD	DE,-1000		CALL	DIGITNUM3		LD	DE,-100		CALL	DIGITNUM2		LD	DE,-10		CALL	DIGITNUM1		LD	A,L		CALL	PRDIG		RET*****************************************	PRINT A DIGIT****************************************DIGIT		XOR	A@LOOP		INC	A		ADD	HL,DE		JP	C,@LOOP		PUSH	AF		LD	A,L		SUB	E		LD	L,A		LD	A,H		SBC	A,D		LD	H,A								POP	AF		DEC	APRDIG		ADD	A,48		PUSH	HL		PUSH	BC		LD	D,7		LD	E,A		LD	A,C		CALL	WRITE_PAN		POP	BC		POP	HL		INC	C		RET	*****************************************	      SHAKE SCREEN****************************************SHAKETAB	DB	8,09,10,11,10,09		DB	8,09,10,09		DB	8,0SHAKESCR	LD	A,(SHAKEPOS)		CP	#FF		JP	NZ,@SHAKE		LD	A,8		LD	(SHAKE_Y),A		RET@SHAKE		LD	HL,SHAKETAB		LD	B,0		LD	C,A		ADD	HL,BC		LD	A,(HL)				AND	A		JP	Z,@END		LD	(SHAKE_Y),A		LD	A,(SHAKEPOS)		INC	A		LD	(SHAKEPOS),A		RET@END		LD	A,#FF		LD	(SHAKEPOS),A		RET*****************************************	      START SHAKE****************************************EARTHSHAKER	XOR	A		LD	(SHAKEPOS),A		RET*********************************************************************************			    UTILITY ROUTINES*************************************************************************************************************************          LOCATE CHAR ON MAP* 		  IN BC****************************************CHPOS		LD	L,B		LD	H,0		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		LD	B,0		ADD	HL,BC		LD	BC,BGPOS		;#9800		ADD	HL,BC		RET*****************************************      LOCATE BACKGROUND DATA*	    B = Y : C = X*	    HL = LOCATION****************************************LOCBAKPOS	LD	H,0		LD	L,B		ADD	HL,HL		;HL = B * 2		ADD	HL,HL		;HL = B * 4		ADD	HL,HL		;HL = B * 8		ADD	HL,HL		;HL = B * 16		ADD	HL,HL		;HL = B * 32		ADD	HL,HL		;HL = B * 64		LD	A,C		RLA		SBC	A,A		LD	B,A		ADD	HL,BC		;HL = MAPRAM + B*32 +C		LD	BC,MAPRAM		ADD	HL,BC		RET*****************************************        RANDOM NUMBER GENERATOR*	    WELL NEAR ENOUGH****************************************RANDOM		PUSH	BC		LD	A,(SEED)		LD	C,A		ADD	A,A		ADD	A,A		ADD	A,A		ADD	A,C		ADD	A,49		LD	(SEED),A		POP	BC		RET*****************************************          INITIALISE HARDWARE****************************************INITHARD      	XOR	A		LDZ	(IF),A		LD	A,%00001101		LDZ	(IE),A		LD	HL,#C000		;CLEAR RAM		LD	BC,#1EFF		;DON'T CLEAR STACK@LOOP		XOR	A		LD	(HLI),A		DEC	BC		LD	A,B		OR	C		JR	NZ,@LOOP		LD	HL,#FFFE		LD	B,#7E		XOR	A@LOOP2		LD	(HLD),A		DJNZ	@LOOP2		LD	HL,#FEFF		DEC	B@LOOP3		LD	(HLD),A		DJNZ	@LOOP3		CALL	DMA_COPY		CALL	SET_DMA_TRANS		;LD	A,%00011011		;ZERO PALETTE		;LDZ	(BGP),A		;LDZ	(OBP0),A		;LDZ	(OBP1),A		RETPALNORM		LD	A,%00011011		LDZ	(BGP),A		RETPALWHITE	LD	A,%00000000		LDZ	(BGP),A		RET*****************************************	   READ GAMEBOY KEYS *	   ~~~~~~~~~~~~~~~~~*	   0 = A    : 1 = B*	   2 = SEL  : 3 = START*	   4 = LEFT : 5 = RIGHT*	   6 = UP   : 7 = DOWN****************************************GETKEYS		LD	A,#20		LD	(P1),A		LD	A,(P1)		LD	A,(P1)		CPL		AND	#0F		SWAP	A		LD	B,A				LD	A,#10		LD	(P1),A				LD	A,(P1)		LD	A,(P1)		LD	A,(P1)		LD	A,(P1)		LD	A,(P1)		LD	A,(P1)		CPL		AND	#0F		OR	B		LD	C,A				LD	A,(KEYS)		XOR	C		AND	C		LD	(TRIGGER),A		LD	A,C		LD	(KEYS),A		LD	A,#30		LD	(P1),A		RET*****************************************	      BUFFER KEYS****************************************BUFFER_KEYS	LD	A,#20		LD	(P1),A		LD	A,(P1)		LD	A,(P1)		CPL		AND	#0F		SWAP	A		LD	B,A				LD	A,#10		LD	(P1),A				LD	A,(P1)		LD	A,(P1)		LD	A,(P1)		LD	A,(P1)		LD	A,(P1)		LD	A,(P1)		CPL		AND	#0F		OR	B		LD	C,A   		;KEYS		LD	A,(QKEYS)	;RECORD KEYS PRESSED		OR	C		LD	(QKEYS),A		LD	A,C		CPL		LD	C,A		LD	A,(QRELKEYS)	;RECORD KEYS NOT PRESSED		OR	C		LD	(QRELKEYS),A				LD	A,#30		LD	(P1),A		RET*****************************************       QUICK KEY PRESS PROCCESSING****************************************	PROCESS_KEYS	LD	A,(QRELKEYS)		;KEYS THAT WERE RELEASED		LD	C,A		LD	A,(QKEYS)		;GET NEW KEYS PUSHED		;AND	C		LD	C,A		LD	A,(KEYS)		;GET OLD KEYS		XOR	C					AND	C		LD	(TRIGGER),A		LD	A,(QKEYS)		LD	(KEYS),A		XOR	A		LD	(QKEYS),A		LD	(QRELKEYS),A	;RELEASED KEYS		RET	*****************************************	  MAKE MIRROR TABLE*	  H = PAGE LOCATION****************************************MAKE_MIR  	LD	L,0		@LOOP		LD	E,L		LD	B,8		XOR	A@LOOP2		SLA	E		RRA		DEC	B		JP	NZ,@LOOP2		LD	(HL),A		INC	L		JP	NZ,@LOOP		RET*****************************************	  MAKE MULTIPLY TABLE*	  ~~~~~~~~~~~~~~~~~~~*	   D = LOW PAGE LOCATION*	 D+1 = HIGH PAGE LOCATION**	  HL = START NUM*         BC = COUNT*	   A = ENTRYS****************************************MAKE_MUL	LDZ	(REG1),A@LOOP		LD	A,L		LD	(DE),A		INC	D		LD	A,H		LD	(DE),A		DEC	D		INC	E		ADD	HL,BC				LDZ	A,(REG1)		DEC	A		LDZ	(REG1),A		JP	NZ,@LOOP		RET*****************************************	     SET TABLES UP****************************************SET_TABLES	LD	H,>MIRPOS		CALL	MAKE_MIR		LD	DE,MULLPOS		LD	HL,#9000		LD	BC,16		LD	A,128		CALL	MAKE_MUL		LD	DE,MULLPOS+128		LD	HL,#8800		LD	BC,16		LD	A,128		CALL	MAKE_MUL		RET*****************************************       PUT DMA STUFF AT #FF80****************************************DMA_COPY	LD	HL,DMAPRG		LD	C,#80		LD	B,10@COPY		LD	A,(HLI)		LD	(C),A		INC	C		DEC	B		JR	NZ,@COPY		RET	*****************************************         END OF PROGRAM****************************************DMA_TRANSFER	EQU	#FF80DMAPRG		LD	A,#C0		LDZ	(#FF46),A		LD	A,#40		;WAS #28@XX		DEC	A		JR	NZ,@XX		RET	*****************************************	     SET DMA TRANSFER****************************************SET_DMA_TRANS	LD	A,1		LD	(DMA_GO),A		RET*****************************************	    TEST DMA TRANSFER****************************************TEST_DMA_TRANS	LD	HL,DMA_GO		LD	A,(HL)		AND	A		RET	Z		LD	(HL),0		CALL	DMA_TRANSFER		RET	*********************************************************************************		BIG TEXT AND LITTLE TEXT DISPLAY STUFF*************************************************************************************************************************	   PRINT ALL GAME TEXT****************************************NUM		= 1		EQUINC	TXT_ROUND		EQUINC	TXT_FIGHT		EQUINC	TXT_FINISH		EQUINC	TXT_WINS		EQUINC	TXT_TIE		EQUINC	TXT_GAMEOVER		EQUINC	TXT_TIME		EQUINC	TXT_STREN		EQUINC	TXT_FLAW		EQUINC	TXT_DFLAW		EQUINC	TXT_FATAL		EQUINC	TXT_OUTSTAND		EQUINC	TXT_TIMEOUTALLTEXT		XOR	A		LD	(LOCKSCROLL),A		LD	A,(ICEBACKTIME)		AND	A		CALL	NZ,PR_DOUBLEICE		LD	A,(TEXTFLAG)		AND	A		RET	Z		LD	A,1		LD	(LOCKSCROLL),A		LD	A,(TEXTFLAG)		CP	TXT_ROUND		JP	Z,PR_ROUND		CP	TXT_GAMEOVER		JP	Z,PR_GAMEOVER		CP	TXT_FIGHT		JP	Z,PR_FIGHT		CP	TXT_TIE		JP	Z,PR_TIE		CP	TXT_FINISH		JP	Z,PR_FINISH		CP	TXT_WINS		JP	Z,PR_WINS		CP	TXT_TIME		JP	Z,PR_TIME		CP	TXT_STREN		JP	Z,PR_STREN		CP	TXT_FLAW		JP	Z,PR_FLAW		CP	TXT_DFLAW		JP	Z,PR_DFLAW		CP	TXT_FATAL		JP	Z,PR_FATAL		CP	TXT_OUTSTAND		JP	Z,PR_OUTSTAND		CP	TXT_TIMEOUT		JP	Z,PR_TIMEOUT		RET*****************************************	       PRINT FIGHT****************************************PR_OUTSTAND	CALL	TEXT		DB	AT,2,5,"OUTSTANDING"		DB	STOP		RET*****************************************	     PRINT ROUND NUM****************************************PR_ROUND 	CALL	TEXT		DB	AT,3,7,"ROUND "		DB	STOP		LD	A,(ROUND_NUM)		ADD	A,48		CALL	MAIN_CHR		RET*****************************************	       PRINT FIGHT****************************************PR_FIGHT	CALL	TEXT		DB	AT,3,8,"FIGHT"		DB	STOP		RET*****************************************	       PRINT FIGHT****************************************PR_TIE		CALL	TEXT		DB	AT,3,8,"DRAW"		DB	STOP		RET*****************************************	       GAME OVER****************************************PR_GAMEOVER	CALL	TEXT		DB	AT,2,6,"GAME OVER"		DB	STOP		RET*****************************************	      PRINT FINISH****************************************PR_FINISH	CALL	WHO_HAS_WON		LD	A,C		CP	_LIZ		JP	Z,@HER		CALL	TEXT		DB	AT,3,5,"FINISH HIM"		DB	STOP		RET@HER		CALL	TEXT		DB	AT,3,5,"FINISH HER"		DB	STOP		RET*****************************************	   PRINT WHO HAS WON****************************************PR_WINS		CALL	WHO_HAS_WON		LD	A,B		CALL	FINDNAME				LD	A,(HLI)		;GET NAME TEXT LEN		LDZ	(REG1),A	;SAVE LEN		ADD	A,4		;ADD " WINS"		SRL	A		SUB	10		CPL		INC	A		LD	C,A		LD	B,0			LD	B,2		PUSH	HL	 	;SAVE NAME POS		CALL	TEXTPOS		POP	HL		LDZ	A,(REG1)		LD	B,A@NAMELOOP	LD	A,(HLI)		PUSH	HL		PUSH	BC		CALL	MAIN_CHR		POP	BC		POP	HL		DJNZ	@NAMELOOP		CALL	TEXT		DB	" WINS"		DB	STOP		RET*****************************************	    TIME BONUS TEXT****************************************PR_TIME		CALL	TEXT		DB	AT,1,2,"TIME BONUS "		DB	STOP		LD	A,(GAMETIME)		; PRINT TIME		LD	L,A		LD	H,0		CALL	MNUM2		CALL	TEXT			;* 1000		DB	",000",STOP		RET*****************************************	    OUT OF TIME TEXT****************************************PR_TIMEOUT	CALL	TEXT		DB	AT,1,5,"OUT OF TIME"		DB	STOP		RET*****************************************	       BONUS TEXT****************************************PR_STREN	CALL	TEXT		DB	AT,1,3,"STRENGTH "		DB	STOP		CALL	WHO_HAS_WON		LD	L,E		LD	H,0		CALL	MNUM2		CALL	TEXT			;* 1000		DB	",000",STOP		RET*****************************************	       BONUS TEXT****************************************PR_FLAW		CALL	TEXT		DB	AT,1,3,"FLAWLESS 200,000"		DB	STOP		RET*****************************************	       BONUS TEXT****************************************PR_DFLAW	CALL	TEXT		DB	AT,1,3,"DOUBLE FLAWLESS"		DB	AT,2,7,"500,000"		DB	STOP		RET*****************************************	       BONUS TEXT****************************************PR_FATAL	CALL	TEXT			       ;0123456789123456789		DB	AT,1,0,"   FINISHING  MOVE"		DB	AT,2,0,"       100,000"		DB	STOP		RET*****************************************	      PRINT TEXT****************************************PR_DOUBLEICE	CALL	TEXT		DB	AT,2,1,"DOUBLE ICE BACKFIRE"		DB	STOP		LD	HL,ICEBACKTIME		DEC	(HL)		LD	A,1		LD	(LOCKSCROLL),A		RET*****************************************	   SETUP IN GAME TEXT****************************************SET_GAME_TEXT	LD	A,1		SETBANK		LD	HL,CHRS_AND_BOXES		LD	DE,TEXTMEM		CALL	UNPACK		RET*****************************************	  PRINT TO MAIN SCREEN****************************************TEXT		POP	HL@LOOP		LD	A,(HL)		CP	STOP		JP	Z,@END		CP	AT		JP	Z,@AT		PUSH	HL		CALL	MAIN_CHR		POP	HL		INC	HL		JP	@LOOP@AT		INC	HL		LD	B,(HL)		INC	HL		LD	C,(HL)		INC	HL		PUSH	HL		CALL	TEXTPOS		POP	HL		JP	@LOOP		@END		INC	HL		JP	(HL)*****************************************	   SET CHR POSITION****************************************TEXTPOS		LD	HL,XPOS		LD	A,(HLI)		LD	H,(HL)		LD	L,A		SRL	H		RR	L		SRL	H		RR	L		SRL	H		RR	L		LD	A,L		ADD	A,C		LD	C,AWIDETEXTPOS	CALL	LOCBAKPOS		LD	A,L		LD	(TEXTADD),A		LD	A,H		LD	(TEXTADD+1),A		RET*****************************************            CONVERT CHR NUMS****************************************CONV_CHR	CP	"#"		JP	Z,@HASH		CP	"@"		JP	Z,@SWISSROLL		CP	"œ"		JP	Z,@POUND		CP	"_"		JP	Z,@ROPE		CP	32		JP	Z,@SPACE		CP	","		JP	Z,@COMMA		CP	"."		JP	Z,@DOT		CP	"A"		JP	NC,@CON_ALFA		CP	"0"		JP	NC,@CONNUMS		RET@CON_ALFA	SUB	"A"		INC	A		;SKIP OVER SPACE		RET@CONNUMS	SUB	"0"		ADD	A,26+1		RET@SPACE		XOR	A		RET@DOT		LD	A,26+11		RET@COMMA		LD	A,26+12		RET@HASH		LD	A,50		RET@SWISSROLL	LD	A,48		RET@POUND		LD	A,49		RET@ROPE		LD	A,53		RET*****************************************	PRINT A CHR TO MAIN SCREEN*	~~~~~~~~~~~~~~~~~~~~~~~~~~*	   (MAINPOS) = MAPRAM ADD* 	    A = CHR TO PRINT****************************************MAIN_CHR	CP	32		JP	Z,@SKIPSPACE		LDZ	(REG1),A		;SAVE CHR TO PRINT		LD	HL,TEXTADD		;GET MAP POS TO PRINT TO		LD	A,(HLI)		LD	H,(HL)		LD	L,A				PUSH	HL			;SAVE MAP POS		LD	DE,CHRDATA		;USE DECOMP AREA		LD	A,(HL) 			;COPY THIS CHR TO CHRDATA		CALL	COPYCHR		LDZ	A,(REG1)		;GET CHR TO PRINT		CALL	CONV_CHR		LD	L,A		LD	H,0		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		LD	DE,TEXTMEM		ADD	HL,DE			;HL = CHR TO PRINT		LD	DE,CHRDATA		;DE = BACKGROUND DATA						;(SP) = MAP POSITION		LD	B,8@LOOP		LD	A,(HLI)			;MAKE MASK		OR	(HL)		DEC	HL		LD	C,A		SRL	A		OR	C		LD	C,A		SRL	A		OR	C		LD	C,A		SLA	A		OR	C		LD	C,A		SLA	A		OR	C		CPL		LD	C,A		LD	A,(DE)		AND	C		OR	(HL)		LD	(DE),A		INC	DE		INC	HL		LD	A,(DE)		AND	C		OR	(HL)		LD	(DE),A		INC	DE		INC	HL		DJNZ	@LOOP		POP	BC			;GET MAP POS		LD	A,C		CALL	PUT_TXT_UNDER		;STORE TEXT POS		LD	A,B		CALL	PUT_TXT_UNDER		LD	A,(BC)		CALL	PUT_TXT_UNDER		;STORE TEXT UNDERDATA		LD	A,%10000000  		;COLLISION BITS		LD	(SPRNUMBIT),A		LD	A,(BC)	   		;IF CHR IS ALREADY IN BACKGROUND		LD	E,A			;E = OLD CHR		CP	STARTSPR		;THEN DONT'T GET A SPARE		JP	NC,@NOSPARE		;ARL 05/04/93		CALL	GETSPARE		;GET A SPARE SPRITE		LD	(BC),A			;PUT CHR ON BAK SCREEN@NOSPARE	CALL	TEST_COLL		LD	HL,CHRDATA		CALL	COPYSPR			;COPY DATA AT HL = CHR A	@SKIPSPACE	LD	HL,TEXTADD		LD	E,(HL)		INC	HL		LD	D,(HL)			INC	DE		LD	(HL),D		DEC	HL		LD	(HL),E		RET*****************************************	 STORE BYTES STRIP DATA****************************************PUT_TXT_UNDER	PUSH	HL		PUSH	DE		LD	HL,UND_TXT_PTR		LD	E,(HL)		INC	HL		LD	D,(HL)		LD	(DE),A		INC	DE				LD	(HL),D		DEC	HL		LD	(HL),E		POP	DE		POP	HL		RET*****************************************     SET TEXT UNDERDATA BUFFER****************************************SET_TEXT	LD	DE,UND_TXT_BUF		LD	HL,UND_TXT_PTR		LD	(HL),E		INC	HL		LD	(HL),D		RET*****************************************    PUT END BYTE IN TEXT BUFFER****************************************END_TEXT	XOR	A		JP	PUT_TXT_UNDER*****************************************      DELETE STRIPS ON BACK MAP****************************************DEL_TEXT	LD	HL,UND_TXT_BUF@LOOP		LD	A,(HLI)			;GET SCR POS		AND	A		RET	Z		LD	E,A			;E = LOW MAP ADD		LD	A,(HLI)			;GET HIGH MAP ADDRESS		LD	D,A		LD	A,(HLI)		CP	STARTSPR		;IF THIS CHR WAS'NT PART		JP	NC,@LOOP		;OF THE ORIGNAL BAKGND						;DON'T PLOT OVER IT.		LD	(DE),A		JP	@LOOP*****************************************       PRINT 8 DIGIT BCD NUMBER*	      NUMBER AT HL****************************************MAIN_BCD	LD	BC,3 		;GET MOST SIGNIFICANT PART		ADD	HL,BC		LD	E,0		;DON'T PRINT TRAIL ZERO'S		LD	B,4@LOOP		LD	A,(HL)		SWAP	A		AND	#0F		ADD	A,48		PUSH	HL		PUSH	DE		PUSH	BC		CALL	MAIN_CHR		POP	BC		POP	DE		POP	HL				LD	A,(HL)		AND	#0F		ADD	A,48		PUSH	HL		PUSH	DE		PUSH	BC		CALL	MAIN_CHR		POP	BC		POP	DE		POP	HL		DEC	HL		DJNZ	@LOOP		RET*****************************************	     PRINT A NUMBER****************************************MNUM2		LD	A,L		CP	10		JP	NC,MN2		PUSH	HL		LD	A,32		CALL	MAIN_CHR		POP	HL			JP	MNUM1MN2		LD	DE,-10		CALL	MDIGITMNUM1		LD	A,L		CALL	MPRDIG		RET*****************************************	   PRINT A DIGIT****************************************MDIGIT		XOR	A@LOOP		INC	A		ADD	HL,DE		JP	C,@LOOP		PUSH	AF		LD	A,L		SUB	E		LD	L,A		LD	A,H		SBC	A,D		LD	H,A								POP	AF		DEC	AMPRDIG		ADD	A,48		PUSH	HL		CALL	MAIN_CHR		POP	HL		RET*****************************************       PRINT MARKER ABOVE SPR 1****************************************GET_LINK_X	LD	A,(CONNECT)		AND	A		JP	Z,@OK		LD	A,(MASTER)		AND	A		JP	NZ,@OK		LD	HL,PLAY_2_SCORE		LD	C,1		LDBA	XCOORD,1		RET@OK		LD	HL,PLAY_1_SCORE		LD	C,0		LDBA	XCOORD,0		RET*****************************************    PRINT  SCORE 8 DIGIT BCD NUMBER****************************************PRINT_SCORE	LD	A,(DEMOFLAG)		AND	A		RET	NZ		XOR	A	    	;NO TRAILING ZERO'S		LD	(ZEROFLAG),A		CALL	GET_LINK_X	;GET MY SCORE IN HL			LD	BC,3 		;GET MOST SIGNIFICANT PART		ADD	HL,BC		PUSH	HL  		CALL	GETLEADZERO		POP	HL		LD	B,4@LOOP		LD	A,(HL)		SWAP	A		AND	#0F		CALL	SC_DIGIT		LD	A,(HL)		AND	#0F		CALL	SC_DIGIT		DEC	HL		DEC	B		JP	NZ,@LOOP		LD	A,(ZEROFLAG)		AND	A		RET	NZ		CPL		LD	(ZEROFLAG),A		LD	C,84		XOR	A		JP	SC_DIGIT*****************************************	     GET LEAD ZERO****************************************GETLEADZERO	LD	B,4		LD	C,56@LOOP		LD	A,(HL)		AND	#F0		JP	NZ,@OUT				LD	A,C		ADD	A,4		LD	C,A				LD	A,(HL)		AND	#0F		JP	NZ,@OUT			LD	A,C		ADD	A,4		LD	C,A		DEC	HL		DJNZ	@LOOP@OUT		RET*****************************************	    PRINT SCORE DIGIT****************************************SC_DIGIT	PUSH	HL		LD	HL,ZEROFLAG		BIT	0,(HL)		JP	NZ,@PRNUM				AND	A		JP	Z,@NONUM@PRNUM		SET	0,(HL)		ADD	A,48		PUSH	BC		CALL	WRITE_SCORE		POP	BC		LD	A,C		ADD	A,8		LD	C,A@NONUM		POP	HL		RET*****************************************         WRITE A SCORE SPRITE*		C = XCOORD****************************************WRITE_SCORE	CALL	CONV_CHR		LD	L,A		LD	H,0		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		ADD	HL,HL		LD	DE,TEXTMEM		ADD	HL,DE		LD	A,1		SETBANK		CALL	GETSPARE_HARD		;GET A SPARE SPRITE		LD	B,24			;YPOS		CALL	PUT_OBJ		CALL	COPYHARDSPR		;COPY DATA AT HL = CHR A			RET*****************************************	      SWITCH ROPE ON****************************************ROPE_OFF	XOR	A		LD	(ROPEFLAG),A		RETROPE_ON		LD	A,1		LD	(ROPEFLAG),A		RETROPE_2_SPEAR	LD	A,2		LD	(ROPEFLAG),A		RET*****************************************	     PRINT THE ROPE****************************************PRINT_ROPE	LD	A,(ROPEFLAG)		AND	A		RET	Z		CP	1		JP	Z,@NORMROPE		CALL	GET_FIRERS		JP	@ROPE_DE@NORMROPE	LDBA	XCOORD,0		LD	E,A		LDBA	XCOORD,1		LD	D,A@ROPE_DE	LD	A,D			;ALWAYS MAKE D GREATEST		SUB	E		JP	NC,@D_GREAT		LD	A,D		LD	D,E		LD	E,A@D_GREAT	LD	A,D		SUB	E		SUB	2		RET	C		AND	A		RET	Z		CP	18			;NOT OVER 18		RET	NC		LD	B,A			;B = LENGTH OF ROPE			PUSH	BC 			;SET POSITION		LD	C,E		LD	B,6		CALL	WIDETEXTPOS		POP	BC@LOOP		PUSH	BC		LD	A,"_"		CALL	MAIN_CHR		POP	BC     		DJNZ	@LOOP		RET*****************************************	     ROPE TO SPEAR****************************************GET_FIRERS	LDBA	OUTBYTE,1		AND	A		JP	NZ,@PLAY1		LDBA	XCOORD,0		LD	D,A		LDBA	XCOORD,2		LD	E,A		RET@PLAY1		LDBA	XCOORD,1		LD	D,A		LDBA	XCOORD,3		LD	E,A		RET