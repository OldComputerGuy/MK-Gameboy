*********************************************************************************		     GAMEBOY TO GAMEBOY LINK PROGRAMS*             WRITTEN BY A.R.HARTLEY 1992*************************************************************************************************************************          INITIALIZE LINKUP****************************************BIGTIMEOUT	EQU	50000			;OUTTIME*4			;0OUTTIME		EQU	500			;500INITLINK	XOR	A	  		;SET TO SLAVE		LD	(MASTER),A		;LISTEN		LD	(CONNECT),A		;NOT CONNECTED		LD	(LASTSENT),A		;CLAER LAST SENT		LD	(LINKBYTE),A		RET*****************************************      		GET BYTE****************************************GET_BYTE	LD	HL,OUTTIME	;SET TIMEOUT@WAIT		DEC	HL		LD	A,H		OR	L		JP	Z,@TIMEOUT		LD	A,(SIOFLAG)		AND	A		JP	Z,@WAIT		LD	A,(SB)		LD	(LASTSENT),A		XOR	A		LD	(SIOFLAG),A		LD	A,#80 		;START TO LISTEN		LDZ	(SC),A		LD	A,(LASTSENT)		OR	A		RET@TIMEOUT	SCF		RET*****************************************      	GET BYTE WITH BIG WAIT****************************************GET_BYTE_WAIT	CALL	VBL_ON		LD	HL,BIGTIMEOUT		LD	B,4@WAIT		DEC	HL		LD	A,H		OR	L		JP	Z,@TIMEOUT		LD	A,(SIOFLAG)		AND	A		JP	Z,@WAIT		LD	A,(SB)		LD	(LASTSENT),A		XOR	A		LD	(SIOFLAG),A		LD	A,#80 		;START TO LISTEN		LDZ	(SC),A		LD	A,(LASTSENT)		OR	A		RET@TIMEOUT	LD	HL,BIGTIMEOUT		DEC	B		JP	NZ,@WAIT		SCF		RET*****************************************             SEND A BYTE*	        A = BYTE****************************************  SEND_BYTE    	LD	B,25		; LET OTHER MACHINE GET IN FRONT@DELAY		NOP		DEC	B		JP	NZ,@DELAY			       		;OTHER MACHINE SHOULD BE READY NOW		LDZ	(SB),A		XOR	A		LD	(SIOFLAG),A			LD	A,#81		;NOW SEND IT 		LDZ	(SC),A@WAIT	    	LD	A,(SIOFLAG)	;WAIT UNTIL TRANSMISSION ENDED		AND	A		JP	Z,@WAIT		XOR	A      		;CLEAR OUT INT FLAG		LD	(SIOFLAG),A		LD	A,#80		;LISTEN		LDZ	(SC),A		RET*****************************************	      HANDLE LINK****************************************HANDLE_LINK	LD	A,(CONNECT)		CP	-1		JP	Z,@DISCON		CP	1		JP	Z,@CONNECT		JP	MAKE_LINK@CONNECT	LD	A,(MASTER)		AND	A		JP	Z,MASTER_IO		JP	SLAVE_IO@DISCON		LD	A,1		SETBANK		XOR	A		LD	(LINKBYTE),A		JP	SHOW_DISCONNECT*****************************************	     MAKE THE LINK****************************************MAKE_LINK	CALL	RANDOM		AND	8		JP	Z,@TRY		JP	WAIT_CONNECT@TRY		CALL	TRY_CONNECT		RET*****************************************       TRY TO MAKE A CONNECTION****************************************TRY_CONNECT	LD	A,#AA	 	;SEND A BYTE		CALL	SEND_BYTE		CALL	GET_BYTE	;GET A BYTE		JP	C,@CRAP		;ERROR IF TIMEOUT		CP	#55		JP	NZ,@CRAP		LD	A,"M"		CALL	SEND_BYTE		LD	A,"K"		CALL	SEND_BYTE		CALL	GET_BYTE	;GET A BYTE		JP	C,@CRAP		;ERROR IF TIMEOUT		CP	#1A		JP	NZ,@CRAP		LD	A,1		;SAY CONNECTED		LD	(CONNECT),A		LD	A,1	  	;I'M YOUR MASTER !!		LD	(MASTER),A		LD	A,%00000100		LD	(MYBIT),A		LD	A,1		SETBANK		JP	SHOW_CONNECTED		OR	A		;SAY CONNECTED		RET@CRAP		SCF			;SAY NOT CONNECTED		RET*****************************************	  WAITING TO CONNECT****************************************WAIT_CONNECT	CALL	VBL_OFF		CALL	GET_BYTE	;GET A BYTE		JP	C,@CRAP		;ERROR IF TIMEOUT		CP	#AA		JP	NZ,@CRAP		LD	A,#55		CALL	SEND_BYTE		CALL	GET_BYTE	;GET A BYTE		JP	C,@CRAP		;ERROR IF TIMEOUT		CP	"M"		JP	NZ,@CRAP		CALL	GET_BYTE	;GET A BYTE		JP	C,@CRAP		;ERROR IF TIMEOUT		CP	"K"		JP	NZ,@CRAP		LD	A,#1A		CALL	SEND_BYTE		LD	A,1		;SAY CONNECTED		LD	(CONNECT),A		XOR	A	  	;I'M YOUR SLAVE !!!		LD	(MASTER),A		LD	A,%00001000		LD	(MYBIT),A		CALL	VBL_ON		LD	A,1		;SAY CONNECTED		SETBANK		JP	SHOW_CONNECTED		RET@CRAP		LD	A,#80 		;START TO LISTEN		LDZ	(SC),A		CALL	VBL_ON		SCF			;SAY NOT CONNECTED		RET*****************************************	     SWITCH VBL OFF****************************************VBL_OFF		LD	A,%00001000		LD	(IE),A		RETVBL_ON		LD	A,%00001101		LD	(IE),A		RET*****************************************		DELAY****************************************DELAY_LINK	LD	HL,10DELAY		DEC	HL		LD	A,H		OR	L		JP	NZ,DELAY		RET		*****************************************	  DO COMMUNICATIONS****************************************GET_IO		LD	A,(CONNECT)	;ARE WE CONNECTED TO A GAMEBOY ?		CP	1		RET	NZ		LD	A,(MASTER)		AND	A		JP	Z,MASTER_IO		JP	SLAVE_IO*****************************************	   MASTER'S IO ROUTINE****************************************MASTER_IO	CALL	VBL_OFF		LD	A,(KEYS) 	;SEND MY KEYS		CALL	SEND_BYTE		CALL	GET_BYTE_WAIT		JP	C,DISCONNECT		LD	C,A		LD	A,(INKEYS)		XOR	C		AND	C		LD	(INTRIG),A		LD	A,C		LD	(INKEYS),A		CALL	VBL_ON		RET	*****************************************	   SLAVE'S IO ROUTINE****************************************SLAVE_IO	CALL	VBL_OFF		CALL	GET_BYTE_WAIT	;GET OTHERS KEYS		JP	C,DISCONNECT		LD	C,A		LD	A,(INKEYS)		XOR	C		AND	C		LD	(INTRIG),A		LD	A,C		LD	(INKEYS),A			LD	B,5		;100 ;MAKE SURE HE'S OVER TAKEN ME@LOOP		DEC	B		JP	NZ,@LOOP			LD	A,(KEYS)	;SEND SLAVE KEYS		CALL	SEND_BYTE		CALL	VBL_ON		RET*****************************************	DISCONNECT COMMUNICATIONS****************************************DISCONNECT	LD	A,-1		LD	(CONNECT),A		JP	VBL_ON